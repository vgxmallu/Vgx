
from __future__ import unicode_literals

import asyncio
import math
import os
import time
from random import randint
from urllib.parse import urlparse

from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import aiofiles
import aiohttp
import requests
import wget
import yt_dlp
from pyrogram import filters, enums
from pyrogram.errors import FloodWait, MessageNotModified
from pyrogram.types import Message
from youtube_search import YoutubeSearch
from yt_dlp import YoutubeDL

from handlers.decorators import humanbytes
#from database.filters import command, other_filters
from mbot.cor import pyro_cooldown
from mbot import LOG_GROUP, Mbot

#from pyrogram.enums import ChatType


ydl_opts = {
    'format': 'best',
    'keepvideo': True,
    'prefer_ffmpeg': False,
    'geo_bypass': True, 
    'outtmpl': '%(title)s.%(ext)s',
    'quite': True
}


# Convert hh:mm:ss to seconds
def time_to_seconds(time):
    stringt = str(time)
    return sum(int(x) * 60 ** i for i, x in enumerate(reversed(stringt.split(':'))))



@Mbot.on_message(filters.command(["song@Musicx_dlbot", "song", "s"]) & pyro_cooldown.wait(10))
def song_gtr(_, message):
    query = " ".join(message.command[1:])
    m = message.reply("üîé")
    n = message.reply_chat_action(enums.ChatAction.TYPING)
    ydl_ops = {"format": "bestaudio[ext=m4a]"}
    try:
        results = YoutubeSearch(query, max_results=1).to_dict()
        link = f"https://youtube.com{results[0]['url_suffix']}"
        title = results[0]["title"]
        views = results[0]["views"]
        performer = f"[·¥ç·¥ús…™·¥Ñ …¢·¥Ä ü·¥Äx è]"
        channel = results[0]["channel"]
        thumbnail = results[0]["thumbnails"][0]
        thumb_name = f"{title}.jpg"
        thumb = requests.get(thumbnail, allow_redirects=True)
        open(thumb_name, "wb").write(thumb.content)
        duration = results[0]["duration"]
        idt = results[0]['id']

        spoti_url = "https://open.spotify.com/search/results/"
        surl = spoti_url + title.replace(' ', '+')
        print(surl)
        google_url = "https://www.google.com/search?q="
        goglurl = google_url + title.replace(' ', '+')
        print(goglurl) 
        soundc_url = "https://soundcloud.com/search?q="
        sdcurl = soundc_url + title.replace(' ', '+')
        print(sdcurl)
        ytmusic_url = "https://music.youtube.com/search?q="
        ytmurl = ytmusic_url + title.replace(' ', '+')
        print(ytmurl) 
        applem_url = "https://music.apple.com/search?term="
        appmurl = applem_url + title.replace(' ', '+')
        print(appmurl)   
        deezer_url = "https://www.deezer.com/search/"
        dezurl = deezer_url + title.replace(' ', '+')
        print(dezurl)
        tidal_url = "https://listen.tidal.com/search/"
        tidaurl = tidal_url + title.replace(' ', '+')
        print(tidaurl)
        pandora_url = "https://www.pandora.com/search/"
        pandrurl = pandora_url + title.replace(' ', '+')
        print(pandrurl)
        hungama_url = "https://www.hungama.com/search/"
        hungurl = hungama_url + title.replace(' ', '+')
        print(hungurl)
        iheart_url = "https://www.iheart.com/search?q="
        iheturl = iheart_url + title.replace(' ', '+')
        print(iheturl)
        jiosaavn_url = "https://www.jiosaavn.com/search?q="
        jiosvurl = jiosaavn_url + title.replace(' ', '+')
        print(jiosvurl)
        gaana_url = "https://gaana.com/search/"
        gaanurl = gaana_url + title.replace(' ', '+')
        print(gaanurl)
        
        amezom_url = "https://music.amazon.com/search/"
        amzmurl = amezom_url + title.replace(' ', '+')
        print(amzmurl)
        itunes_url = "https://geo.music.apple.com/search?term="
        itunsurl = itunes_url + title.replace(' ', '+')
        print(itunsurl)

        napsr_url = "https://us.napster.com/search?q="
        napsrurl = napsr_url + title.replace(' ', '+')
        print(napsrurl)
        wynk_url = "https://wynk.in/music/search?q="
        wynkurl = wynk_url + title.replace(' ', '+')
        print(wynkurl)
        qobuz_url = "https://www.qobuz.com/search?q="
        qobuzurl = qobuz_url + title.replace(' ', '+')
        print(qobuzurl)



        if time_to_seconds(duration) >= 900:  # duration limit
            m.edit(f"**Duration Limit Exceeded:**\n\n**Allowed Duration:** 10 minute(s)\n**Received Duration:** {duration} hour(s)\nSend songs less than 10 minutes")
            return

    except Exception as e:
        m.edit(f"Nothing Found {message.from_user.first_name} :(\n\nPlease check, you using correct format or your spellings are correct and try again.\n Correct Format : /song song_name or /s song_name")
        print(str(e))
        return
    m.edit("üì§") 
    dForChat = message.reply_chat_action(enums.ChatAction.UPLOAD_AUDIO)

    PForCopy = message.reply_photo(photo=f"{link}.jpg", caption=f"üéß<b>Title:</b> <code>{title}</code>\nüé§<b>Artist:</b> <code>{channel}</code>\n<b>‚è±Ô∏èDuration:</b> <code>{duration}</code>\nüÜî<b>Song Id:</b> <code>{idt}</code>\nüîó<b>Link:</b> [Click here]({link})")
    try:
        with yt_dlp.YoutubeDL(ydl_ops) as ydl:
            info_dict = ydl.extract_info(link, download=False)
            audio_file = ydl.prepare_filename(info_dict)
            ydl.process_info(info_dict)
        rep = f"<i>[song.link]({link}) | [via](t.me/Musicx_dlbot)</i>"
        secmul, dur, dur_arr = 1, 0, duration.split(":")
        for i in range(len(dur_arr) - 1, -1, -1):
            dur += int(float(dur_arr[i])) * secmul
            secmul *= 60
        m.edit("üì•") 
        dForChat = message.reply_chat_action(enums.ChatAction.UPLOAD_AUDIO)
        AForCopy = message.reply_audio(
            audio_file,
            caption=rep,
            thumb=thumb_name, 
            performer=performer,
            title=title,
            duration=dur,
        )
        message.reply_text(f"**{title}**\n\nPlease choose a service below\n@Musicx_dlbot | @songdownload_group",   
          reply_markup=InlineKeyboardMarkup([[
          InlineKeyboardButton("YouTube", url=f"{link}"), 
          InlineKeyboardButton("YouTube Music", url=f"{ytmurl}"), 
          InlineKeyboardButton("Spotify", url=f"{surl}")
          ],[ 
          InlineKeyboardButton("Sound Cloud", url=f"{sdcurl}"), 
          InlineKeyboardButton("Hungama", url=f"{hungurl}"), 
          InlineKeyboardButton("Jio Saavn", url=f"{jiosvurl}")
          ],[
          InlineKeyboardButton("Google", url=f"{goglurl}"), 
          InlineKeyboardButton("Gaana", url=f"{gaanurl}"), 
          InlineKeyboardButton("iHeart", url=f"{iheturl}")
          ],[
          InlineKeyboardButton("Tidal", url=f"{tidaurl}"), 
          InlineKeyboardButton("Deezer", url=f"{dezurl}"), 
          InlineKeyboardButton("Apple Music", url=f"{appmurl}")
          ],[
          InlineKeyboardButton("Pandora", url=f"{pandrurl}"), 
          InlineKeyboardButton("Amazon Music", url=f"{amzmurl}"), 
          InlineKeyboardButton("iTunes", url=f"{itunsurl}")
          ],[
          InlineKeyboardButton("Napster", url=f"{napsrurl}"), 
          InlineKeyboardButton("Wynk", url=f"{wynkurl}"), 
          InlineKeyboardButton("Qobuz", url=f"{qobuzurl}") 
          ]]
          )
      )
        
        if LOG_GROUP:
            PForCopy.copy(LOG_GROUP)
            AForCopy.copy(LOG_GROUP)
       
        m.delete()
    except Exception as e:
        m.edit("#ERROR\n\nOr you can also use this command to download songs /mp3")
        print(e)

    try:
        os.remove(audio_file)
        os.remove(thumb_name)
    except Exception as e:
        print(e)
